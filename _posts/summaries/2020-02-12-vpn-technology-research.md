
![](https://gitee.com/juzii/res/raw/master/pic/2020/02/head.jpg)

  2020年注定是不平凡的一年，这一年的春节非比寻常，大家闭门不出，湖北、武汉，牵动着每一个中国人的心。随着疫情的不断升级，全国各省均已开始戒严，各单位、小区封闭式管理。随着春节假期的结束，各大互联网公司都纷纷采用远程办公的方式来恢复工作。此时大家会接触到一个叫做VPN的东西，那么什么是VPN呢？他又能帮助我们做什么呢？跟我一起来探秘吧。

# VPN的功能

  VPN是Virtual Private Network的缩写，一般翻译为虚拟专用网络或者虚拟私人网络，他的功能是在公共网络上建立专用网络，进行加密通讯。在企业中有广泛应用。VPN网关通过对数据包的加密与数据包目标地址的转换实现远程访问，可通过服务器、硬件、软件等多种方式来实现。

  例如，我们现在在家办公，使用家里的电脑想要访问公司内部的服务器资源（例如内部论坛、内部服务等）或者远程操控自己办公室的电脑，这时候就需要VPN的帮忙，我们才能够连接成功。有的同学可能会问，两台电脑都连着互联网，不应该是互通的吗？为什么还需要VPN才能连接呢？这时就需要先解释一下内网地址。

# 内网地址

  目前主流的网络设备使用的是TCP/IP协议族，每个网络设备都有一个ip地址，通过IP协议来进行网络寻址，从而达到不同网络设备之间收发数据的目的。目前主流的IP地址仍然是IPv4地址，其长度为32位，因此IPv4地址的总量为2^32约42亿个。这个数字虽然已经很大，但明显是不够用的。以全世界60亿人口为例，大约每3个人只能获得2个ip地址。而随IP地址的规划很不合理，存在许多浪费与分配不均的情况。着移动互联网的普及，人手2-3台的网络设备已经不足为奇，例如手机、平板电脑、笔记本电脑、台式电脑、网络摄像头等等。

  为了解决IPv4地址不足的问题，人们发明了NAT技术（Network Address Translation，网络地址转换），该技术允许将IP地址划分为公网地址与内网地址，公网地址可以在因特网上通信，如果是内网地址的设备，需要在NAT网关（一般是路由器）做网络地址转换后才能与公网地址设备通信。如下图所示，Host A、Host B、Host C的IP地址均为内网地址，因此他们处于同于内网当中，又称为局域网。这3台网络设备要访问互联网中的设备时，需要NAT设备才能够访问到，那么NAT的工作原理是什么样的呢？

![](https://gitee.com/juzii/res/raw/master/pic/2020/02/nat.png)

# NAT的原理

  NAT将自动修改IP报文的源IP地址和目的IP地址，IP地址校验会在NAT处理过程中自动完成。具体过程如下：

1. 如图中Host A的gateway（网关）设定为NAT设备，所以当要连上 Internet 的时候，该封包就会被送到 NAT设备，这个时候的封包 Header里的source IP（源IP）为 192.168.1.1。
2. 而透过这个 NAT设备，它会将 client 的对外联机封包的 source IP ( 192.168.1.1 ) 修改为NAT设备的公共 IP ，因为是公共 IP 了，所以这个封包就可以连上 Internet 了，同时 NAT 主机并且会记忆这个联机的封包是由哪一个 ( 192.168.1.1) client 端传送来的。
3. 而由 Internet 传送回来的封包，当然由 NAT设备来接收了，这个时候，NAT设备会去查询原本记录的路由信息，并将目标 IP 由NAT上面的公共 IP 改回原来的 192.168.1.1。
4. 最后则由 NAT设备将该封包传送给原先发送封包的Host A。

  从以上步骤可以看出，NAT可以实现内网设备访问互联网（Internet）中的公网设备（Server）的过程。但如果反过来呢？如果假设Host B是内网中的某台服务器，当我们的主机处于互联网中（例如Server）或其他NAT内网当中的某台设备，可以通过NAT来访问到Host B吗？答案是否定的，NAT无法实现反向访问的地址转换。也就是说，我们可以通过办公室电脑来访问百度（baidu.com）等外部服务，但百度等外部服务没有办法**主动**访问我们的电脑。从某种程度上看，其实这也是内网地址的另一优点，他可以使我们的内网设备隔离于互联网，从而避免来自互联网的网络攻击。

# VPN的原理

  通过以上内网地址与NAT原理的讲解，我们知道了虽然两台设备接入了网络，但如果访问的目标设备位于内网（局域网）当中，由于内部网络的屏蔽，就没办法直接访问，此时VPN就可以上场了。

![](https://gitee.com/juzii/res/raw/master/pic/2020/02/vpn.jpg)

  如上图所示，红色的虚线代表VPN连接。出差人员或分公司人员（节点1、节点4）通过互联网（Internet）接入网络，然后建立了一条与总部VPN网关（UTT 3640）的一条虚拟链路，通过这条虚拟链路，就能使得互联网上的设备也能访问总部局域网中的设备。

# VPN协议的分类

![](https://gitee.com/juzii/res/raw/master/pic/2020/02/vpn_protocol.png)

  从Windows 7自带的VPN客户端可以看到，常用的VPN隧道协议有PPTP、L2TP/IPSec、SSTP、IKEv2。

* PPTP：由微软主导开发，要求互联网络为IP网络，使用传输控制协议（TCP）创建控制通道来发送控制命令，利用通用路由封装（GRE）通道来封装点对点协议（PPP）数据包以发送数据，简单易用，但加密方式简单容易被破解，支持Windows，Linux，Android。
* L2TP/IPSec：是一种工业标准的Internet隧道协议，功能大致和PPTP协议类似，同样可以对网络数据流进行加密，同样封装PPP协议。但L2TP只要求面向数据包的点对点连接，可提供包头压缩、隧道验证，而PPTP不支持。经常与IPsec搭配使用，因此通常合称L2TP/IPsec。
* SSTP：又称安全套接字隧道协议，同样由微软开发，是PPTP的升级版，更加安全，但缺点是只能用于windows，相对于其他协议使用较少。
* IKEv2：采用了一种 “MOBIKE” – Mobility and Multihoming 技术来维持加密通讯，这让IKEv2连接在用户自身网络状况经常变化的情况下仍旧能够维持加密连接。IKEv2是IKE（v1）的改良版，使用了公钥证书和密码等多重认证，弥补了v1时代的安全性上的不足。比PPTP/L2TP更是可靠许多，同时IKEv2还支持硬件加速，保证了高效的传输效率。

# VPN实战

  光有以上的理论分析，我觉得还不够，因为只有亲手搭建一个VPN服务器，才能够对VPN有更深入的理解。搭建VPN服务器有多种方式，我选择的是成本最低的使用软件的方式搭建，隧道协议我也是选择的最简单的PPTP协议。步骤如下：

1. 登陆有公网IP的Linux服务器，我的服务器系统为CentOS Linux release 7.7.1908，公网ip为112.x.x.207。
2. 安装pptpd服务：`sudo yum install pptpd`。
3. 设置vpn服务器的本地ip与允许的远程ip：`sudo vi /etc/pptpd.conf`，添加`localip 112.x.x.207`，将该服务器的公网ip设置为本地ip，不设置远程ip代表允许任意ip连接。
4. 设置Windows客户端的DNS（如果需要从windows连接）：`sudo vi /etc/ppp/options.pptpd`，添加`ms-dns 114.114.114.114`，即可用的dns服务器地址。
5. 添加用户名与密码：`sudo vi /etc/ppp/chap-secrets`，添加`ljx_vpn pptpd 123456 *`，分别代表用户名，服务名，密码，允许连接的ip，*代表任意ip。
6. 允许ip转发：`sudo vi /etc/sysctl.conf`，添加`net.ipv4.ip_forward = 1`。
7. 生效ip转发：`sudo sysctl -p`，如果不用这个命令需要重启服务器才能生效。
8. 添加防火墙规则：首先是`iptables -A INPUT -p tcp --dport 1723 -j ACCEPT`，使1723即PPTP连接允许通过防火墙。然后需要`iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE`，使eth0开启NAT转换。
9. 启动pptpd服务：`systemctl start pptpd.service`，需要使用root密码。

  完成以后，可以使用`systemctl status pptpd.service`来查看pptpd服务是否启动成功。

![](https://gitee.com/juzii/res/raw/master/pic/2020/02/pptpd.png)

注：如果你跟我一样使用的是云服务器，还需要在云服务器管理后台开启1723的端口访问，客户端才能够连接上。

## 连接测试

  我使用的是Windows 7自带客户端来连接，操作步骤如下：

1. 点右下角网络连接图标，打开“网络与共享中心”
2. 点击“设置新的连接或网络”
3. 选择“连接到工作区”，点击下一步
4. 选择“否，创建新连接”，点击下一步
5. 点击“使用我的Internet连接（VPN）”
6. 在Internet地址中输入VPN服务器地址，即我们上面部署的服务器的外网地址；在目标名称中填写连接的名字，例如"vpn_test"，然后点击下一步
7. 在用户名与密码框中填写我们在搭建VPN时设置的用户名与密码，勾选记住密码，点击连接，如果一切正常的话，就会看到“正在验证用户名和密码”、“正在网络上注册您的计算机”、“已连接”等提示飘过。

  通过以上操作，说明VPN已连接上。

## 验证VPN

  如何来验证我们的VPN连接是否成功呢？最简单的方法就是打开浏览器，输入网址http://ip138.com，这个网站可以显示你当前的公网ip。

![](https://gitee.com/juzii/res/raw/master/pic/2020/02/ip.png)

  例如，我显示的ip地址为112.x.x.207，正是我服务器的公网地址，所以验证了VPN连接成功。

## 连接过程分析

  通过查看VPN服务器的/var/log/messages文件，我们可以看到VPN连接过程产生的系统日志。

![](https://gitee.com/juzii/res/raw/master/pic/2020/02/connection_log.png)

  首先是pptpd服务接受客户端连接请求（118.x.x.13为我原本的公网ip），然后运行起pppd服务，与客户端进行授权校验、数据压缩协商等等，最后分配给客户端一个远程ip：192.168.1.1，进行点对点通信。在Windows上打开命令提示符，输入`ipconfig`可以看到：

![](https://gitee.com/juzii/res/raw/master/pic/2020/02/client_ppp_ip.png)

  VPN在动在客户端主机上新建了一个虚拟网卡：PPP适配器，客户端通过该虚拟网卡，将数据通过ppp协议发送到了VPN服务器，而不是用过原有网卡发送，从而实现了虚拟专用网络（VPN）的功能。

# VPN的法律风险

  许多小伙伴都有访问“境外网站”的需求，可能大家都有发现，VPN是越来越贵了，稳定的VPN也是越来越难找了，甚至一度出现了有价无市的情况。这是什么原因呢？因为，私自搭建**国际线路**的VPN是违法行为（国内线路的VPN不是）。

> 根据[《中华人民共和国计算机信息网络国际联网管理暂行规定》](http://www.cac.gov.cn/1996-02/02/c_126468621.htm)的规定，第六条：计算机信息网络直接进行国际联网，必须使用邮电部国家公用电信网提供的国际出入口信道。 任何单位和个人不得自行建立或者使用其他信道进行国际联网。第十四条：违反本规定第六条、第八条和第十条的规定的，由公安机关责令停止联网，给予警告，可以并处15000元以下的罚款；有违法所得的，没收违法所得。

  因为VPN属于虚拟链路，也可以认定为是信道，所以不能私自搭建国际VPN线路。那么有没有合法的国际线路的VPN可以使用呢？有的。

> 根据[《工业和信息化部关于清理规范互联网网络接入服务市场的通知》](http://www.miit.gov.cn/n1146285/n1146352/n3054355/n3057709/n4704651/c5471876/content.html)的规定：未经电信主管部门批准，不得自行建立或租用专线（含虚拟专用网络VPN）等其他信道开展跨境经营活动。基础电信企业向用户出租的国际专线，应集中建立用户档案，向用户明确使用用途仅供其内部办公专用，不得用于连接境内外的数据中心或业务平台开展电信业务经营活动。

  也就是说，如果要搭建国际线路的VPN，需要向电信主管部门申请，或者向基础电信企业（移动、联通、电信）租用。如果公司提供了国际线路VPN，我们员工可以使用吗？答案是肯定的，但是必须要明确使用用途为办公用途，不得能用于其他用途，更不能浏览或者传播非法内容。

> 根据[《计算机信息网络国际联网安全保护管理办法（公安部令第33号）》](https://www.mps.gov.cn/n2254314/n2254409/n2254443/n2254451/c4113546/content.html)第五条的规定：任何单位和个人不得利用国际联网制作、复制、查阅和传播下列信息：...(五)捏造或者歪曲事实，散布谣言，扰乱社会秩序的；(六)宣扬封建迷信、淫秽、色情、赌博、暴力、凶杀、恐怖，教唆犯罪的；...等等

# 总结

  VPN技术为我们的远程办公提供了便利，使我们不在公司也能够访问到公司的内部网络资源，让我们能够更好的控制疫情的传播。在使用VPN尤其是国际线路的VPN时，要做到严于律己，不访问与办公无关的网站、服务，自觉抵制反动言论，做到敬业、守法、爱国。

  希望这场疫情能够尽快结束，我们能早日摘下口罩，迎接美丽的春天。武汉加油，中国加油！


